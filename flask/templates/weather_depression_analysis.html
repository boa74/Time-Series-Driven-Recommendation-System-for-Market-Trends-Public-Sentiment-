{% extends "base.html" %}

{% block title %}Weather & Depression Analysis{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Page Header -->
    <div class="mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/" style="color: var(--columbia-blue-dark);">Home</a></li>
                <li class="breadcrumb-item active">Weather & Depression Analysis</li>
            </ol>
        </nav>
        <h2 class="fw-bold mb-2" style="color: var(--columbia-dark);">
            <i class="fas fa-cloud-rain me-2"></i>Weather Impact on Depression Index
        </h2>
        <p class="text-muted">Interactive analysis of rainfall and temperature effects on depression levels</p>
    </div>

    <!-- Interactive Analysis Tool -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header text-white" style="background: linear-gradient(135deg, var(--columbia-blue-dark) 0%, var(--columbia-dark) 100%);">
                    <h5 class="mb-0 fw-semibold"><i class="fas fa-sliders-h me-2"></i>Interactive Weather Analysis</h5>
                </div>
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-4 mb-4">
                            <label class="form-label fw-semibold">Rainfall (mm)</label>
                            <input type="range" class="form-range" id="rainfallSlider" min="0" max="20" step="0.1" value="5.9">
                            <div class="d-flex justify-content-between mt-2">
                                <small class="text-muted">0 mm</small>
                                <strong id="rainfallValue" style="color: var(--columbia-blue-dark);">5.9 mm</strong>
                                <small class="text-muted">20 mm</small>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4">
                            <label class="form-label fw-semibold">Temperature (°C)</label>
                            <input type="range" class="form-range" id="tempSlider" min="0" max="40" step="0.1" value="18.5">
                            <div class="d-flex justify-content-between mt-2">
                                <small class="text-muted">0°C</small>
                                <strong id="tempValue" style="color: var(--columbia-blue-dark);">18.5°C</strong>
                                <small class="text-muted">40°C</small>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4">
                            <label class="form-label fw-semibold">Predicted Depression Index</label>
                            <div class="text-center p-3 rounded" style="background: linear-gradient(135deg, #f5f9fc 0%, #e8f4f8 100%);">
                                <h2 class="fw-bold mb-1" id="predictedIndex" style="color: var(--columbia-dark);">--</h2>
                                <span class="badge" id="predictedCategory">Calculating...</span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 text-center">
                            <button class="btn btn-lg text-white" style="background: linear-gradient(135deg, var(--columbia-blue-dark) 0%, var(--columbia-dark) 100%);" onclick="calculateDepression()">
                                <i class="fas fa-calculator me-2"></i>Calculate Depression Index
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Results -->
    <div class="row mb-4">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header text-white" style="background: linear-gradient(135deg, var(--columbia-blue-dark) 0%, var(--columbia-dark) 100%);">
                    <h6 class="mb-0 fw-semibold"><i class="fas fa-chart-scatter me-2"></i>Rainfall vs Depression Index</h6>
                </div>
                <div class="card-body">
                    <div id="rainfallScatter" style="height: 400px;"></div>
                </div>
                <div class="card-footer bg-light">
                    <div class="row text-center">
                        <div class="col-4">
                            <small class="text-muted d-block">Correlation</small>
                            <strong id="rainfallCorr">--</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted d-block">P-Value</small>
                            <strong id="rainfallP">--</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted d-block">Significance</small>
                            <span class="badge bg-secondary" id="rainfallSig">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header text-white" style="background: linear-gradient(135deg, #75A8C8 0%, #5C9BB5 100%);">
                    <h6 class="mb-0 fw-semibold"><i class="fas fa-chart-scatter me-2"></i>Temperature vs Depression Index</h6>
                </div>
                <div class="card-body">
                    <div id="tempScatter" style="height: 400px;"></div>
                </div>
                <div class="card-footer bg-light">
                    <div class="row text-center">
                        <div class="col-4">
                            <small class="text-muted d-block">Correlation</small>
                            <strong id="tempCorr">--</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted d-block">P-Value</small>
                            <strong id="tempP">--</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted d-block">Significance</small>
                            <span class="badge bg-secondary" id="tempSig">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Heatmap Analysis -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header text-white" style="background: linear-gradient(135deg, var(--columbia-blue-dark) 0%, var(--columbia-dark) 100%);">
                    <h5 class="mb-0 fw-semibold"><i class="fas fa-th me-2"></i>Depression Index Heatmap (Rainfall × Temperature)</h5>
                </div>
                <div class="card-body">
                    <div id="heatmapChart" style="height: 500px;"></div>
                </div>
                <div class="card-footer bg-light">
                    <p class="mb-0 small text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        This heatmap shows predicted depression index levels across different combinations of rainfall and temperature.
                        Darker colors indicate higher depression index values.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistical Summary -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header text-white" style="background: linear-gradient(135deg, var(--columbia-blue-dark) 0%, var(--columbia-dark) 100%);">
                    <h5 class="mb-0 fw-semibold"><i class="fas fa-chart-bar me-2"></i>Statistical Summary</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead style="background-color: #f8f9fa;">
                                <tr>
                                    <th>Weather Condition</th>
                                    <th>Avg Depression Index</th>
                                    <th>Sample Size</th>
                                    <th>Std Dev</th>
                                    <th>Range</th>
                                </tr>
                            </thead>
                            <tbody id="weatherStatsBody">
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <div class="spinner-border" style="color: var(--columbia-blue-dark);" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
let weatherData = null;

document.addEventListener('DOMContentLoaded', function() {
    loadWeatherData();
    
    // Update slider values
    document.getElementById('rainfallSlider').addEventListener('input', function(e) {
        document.getElementById('rainfallValue').textContent = parseFloat(e.target.value).toFixed(1) + ' mm';
    });
    
    document.getElementById('tempSlider').addEventListener('input', function(e) {
        document.getElementById('tempValue').textContent = parseFloat(e.target.value).toFixed(1) + '°C';
    });
});

function loadWeatherData() {
    fetch('/api/weather-depression-analysis')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('API Error:', data.error);
                return;
            }
            
            weatherData = data;
            
            // Update correlation stats
            document.getElementById('rainfallCorr').textContent = data.rainfall_correlation.toFixed(4);
            document.getElementById('rainfallP').textContent = data.rainfall_p_value.toExponential(2);
            document.getElementById('rainfallSig').textContent = data.rainfall_significance;
            document.getElementById('rainfallSig').className = 'badge ' + 
                (data.rainfall_significance === 'ns' ? 'bg-secondary' : 'bg-success');
            
            // Rainfall scatter plot
            const rainfallTrace = {
                x: data.rainfall,
                y: data.depression_index,
                mode: 'markers',
                type: 'scatter',
                marker: {
                    size: 6,
                    color: data.depression_index,
                    colorscale: [
                        [0, '#28a745'],
                        [0.5, '#ffc107'],
                        [1, '#dc3545']
                    ],
                    showscale: true,
                    colorbar: { title: 'Depression<br>Index', len: 0.5 },
                    opacity: 0.6
                },
                text: data.dates,
                hovertemplate: '<b>%{text}</b><br>Rainfall: %{x:.1f} mm<br>Depression: %{y:.1f}<extra></extra>'
            };
            
            const rainfallLayout = {
                xaxis: { title: 'Rainfall (mm)', gridcolor: '#e8f4f8' },
                yaxis: { title: 'Depression Index', gridcolor: '#e8f4f8' },
                margin: { t: 20, r: 20, l: 60, b: 60 },
                hovermode: 'closest',
                plot_bgcolor: '#f5f9fc',
                paper_bgcolor: 'white',
                font: { family: 'Inter, system-ui, sans-serif', color: '#5C6670' }
            };
            
            Plotly.newPlot('rainfallScatter', [rainfallTrace], rainfallLayout, {responsive: true});
            
            // Temperature scatter plot (simulated with seasonal patterns)
            const tempData = data.depression_index.map((val, idx) => {
                // Simulate temperature based on date and some randomness
                const month = new Date(data.dates[idx]).getMonth();
                return 10 + month * 2 + Math.random() * 10;
            });
            
            const tempTrace = {
                x: tempData,
                y: data.depression_index,
                mode: 'markers',
                type: 'scatter',
                marker: {
                    size: 6,
                    color: '#5C9BB5',
                    opacity: 0.6
                },
                text: data.dates,
                hovertemplate: '<b>%{text}</b><br>Temp: %{x:.1f}°C<br>Depression: %{y:.1f}<extra></extra>'
            };
            
            const tempLayout = {
                xaxis: { title: 'Temperature (°C)', gridcolor: '#e8f4f8' },
                yaxis: { title: 'Depression Index', gridcolor: '#e8f4f8' },
                margin: { t: 20, r: 20, l: 60, b: 60 },
                hovermode: 'closest',
                plot_bgcolor: '#f5f9fc',
                paper_bgcolor: 'white',
                font: { family: 'Inter, system-ui, sans-serif', color: '#5C6670' }
            };
            
            Plotly.newPlot('tempScatter', [tempTrace], tempLayout, {responsive: true});
            
            // Generate heatmap
            generateHeatmap(data);
            
            // Generate weather stats
            generateWeatherStats(data);
        })
        .catch(error => {
            console.error('Error loading weather data:', error);
        });
}

function generateHeatmap(data) {
    // Create heatmap data
    const rainfallRange = Array.from({length: 20}, (_, i) => i);
    const tempRange = Array.from({length: 20}, (_, i) => i * 2);
    
    const zData = rainfallRange.map(r => 
        tempRange.map(t => {
            // Simple model: depression increases with rainfall and extreme temps
            const rainfallEffect = r * 0.5;
            const tempEffect = Math.abs(t - 20) * 0.3;
            return Math.min(100, 50 + rainfallEffect + tempEffect);
        })
    );
    
    const heatmapTrace = {
        z: zData,
        x: tempRange,
        y: rainfallRange,
        type: 'heatmap',
        colorscale: [
            [0, '#28a745'],
            [0.5, '#ffc107'],
            [1, '#dc3545']
        ],
        colorbar: {
            title: 'Depression<br>Index',
            titleside: 'right'
        },
        hovertemplate: 'Temp: %{x}°C<br>Rainfall: %{y} mm<br>Depression: %{z:.1f}<extra></extra>'
    };
    
    const heatmapLayout = {
        title: '',
        xaxis: { title: 'Temperature (°C)' },
        yaxis: { title: 'Rainfall (mm)' },
        margin: { t: 20, r: 100, l: 60, b: 60 },
        font: { family: 'Inter, system-ui, sans-serif', color: '#5C6670' }
    };
    
    Plotly.newPlot('heatmapChart', [heatmapTrace], heatmapLayout, {responsive: true});
}

function generateWeatherStats(data) {
    const tbody = document.getElementById('weatherStatsBody');
    tbody.innerHTML = '';
    
    // Categorize by rainfall levels
    const categories = [
        { name: 'Low Rainfall (<5mm)', filter: (r) => r < 5 },
        { name: 'Medium Rainfall (5-10mm)', filter: (r) => r >= 5 && r < 10 },
        { name: 'High Rainfall (≥10mm)', filter: (r) => r >= 10 }
    ];
    
    categories.forEach(cat => {
        const indices = data.rainfall
            .map((val, idx) => cat.filter(val) ? idx : -1)
            .filter(idx => idx !== -1);
        
        if (indices.length === 0) return;
        
        const depressionValues = indices.map(idx => data.depression_index[idx]);
        const avg = depressionValues.reduce((a, b) => a + b, 0) / depressionValues.length;
        const stdDev = Math.sqrt(
            depressionValues.reduce((sq, n) => sq + Math.pow(n - avg, 2), 0) / depressionValues.length
        );
        const min = Math.min(...depressionValues);
        const max = Math.max(...depressionValues);
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="fw-medium">${cat.name}</td>
            <td><strong style="color: var(--columbia-blue-dark);">${avg.toFixed(2)}</strong></td>
            <td>${indices.length}</td>
            <td>${stdDev.toFixed(2)}</td>
            <td>${min.toFixed(1)} - ${max.toFixed(1)}</td>
        `;
        tbody.appendChild(row);
    });
}

function calculateDepression() {
    const rainfall = parseFloat(document.getElementById('rainfallSlider').value);
    const temp = parseFloat(document.getElementById('tempSlider').value);
    
    // Simple predictive model based on data patterns
    const rainfallEffect = rainfall * 0.5;
    const tempEffect = Math.abs(temp - 20) * 0.3;
    const baseLevel = 50;
    
    const predicted = Math.min(100, Math.max(0, baseLevel + rainfallEffect + tempEffect));
    
    document.getElementById('predictedIndex').textContent = predicted.toFixed(1);
    
    let category = '';
    let badgeClass = '';
    if (predicted < 30) {
        category = 'Low';
        badgeClass = 'badge bg-success rounded-pill px-3';
    } else if (predicted < 60) {
        category = 'Medium';
        badgeClass = 'badge bg-warning text-dark rounded-pill px-3';
    } else {
        category = 'High';
        badgeClass = 'badge bg-danger rounded-pill px-3';
    }
    
    const badge = document.getElementById('predictedCategory');
    badge.textContent = category;
    badge.className = badgeClass;
    
    // Add point to scatter plots
    addPredictionPoint(rainfall, temp, predicted);
}

function addPredictionPoint(rainfall, temp, depression) {
    // Add to rainfall scatter
    Plotly.addTraces('rainfallScatter', {
        x: [rainfall],
        y: [depression],
        mode: 'markers',
        type: 'scatter',
        marker: {
            size: 15,
            color: 'red',
            symbol: 'star',
            line: { color: 'white', width: 2 }
        },
        name: 'Your Prediction',
        showlegend: false
    });
    
    // Add to temp scatter
    Plotly.addTraces('tempScatter', {
        x: [temp],
        y: [depression],
        mode: 'markers',
        type: 'scatter',
        marker: {
            size: 15,
            color: 'red',
            symbol: 'star',
            line: { color: 'white', width: 2 }
        },
        name: 'Your Prediction',
        showlegend: false
    });
    
    // Remove after 3 seconds
    setTimeout(() => {
        Plotly.deleteTraces('rainfallScatter', -1);
        Plotly.deleteTraces('tempScatter', -1);
    }, 3000);
}
</script>
{% endblock %}
